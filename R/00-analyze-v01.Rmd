---
author: ""
date: ""
output:
  html_document::
    toc: false
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(
  echo = TRUE,
  cache = FALSE,
  results = "markdown",
  fig.align = "center",
  fig.show = "asis",
  fig.width = 6,
  fig.height = 6,
  # out.width = 6,
  # out.height = 6,
  warning = FALSE,
  message = FALSE
)
```

```{r packages}
library("dplyr")
library("stringr")
library("gh")
library("purrr")
```


```{r posts_info, eval = FALSE, include = FALSE}
# Rerference:
# + https://itsalocke.com/blog/markdown-based-web-analytics-rectangle-your-blog/
posts <-
  gh::gh(
    endpoint = "/repos/:owner/:repo/contents/:path",
    owner = "rweekly",
    repo = "rweekly.org",
    path = "_posts"
  )

posts_info <-
  dplyr::data_frame(
    name = purrr::map_chr(posts, "name"),
    path = purrr::map_chr(posts, "path")
  )
```

```{r eval = FALSE, include = FALSE}
# filepath_data <- file.path("data", "posts-rweekly.rds")
# saveRDS(posts_info, file = filepath_data)
# posts_info <- readRDS(filepath_data)
# filepath_data <- file.path("data", "posts-rweekly.csv")
# readr::write_csv(posts_info, filepath_data)
# posts_info <- readr::read_csv(filepath_data)
```

```{r}
get_rweekly_post_content <-
  function(filepath) {
    # Debugging...
    # path <- posts[[1]]$path
    
    # filepath <-
    #   gh::gh(
    #     "/repos/:owner/:repo/contents/:path",
    #     owner = "rweekly",
    #     repo = "rweekly.org",
    #     path = path
    #   )

    filepath_prefix <- "data-raw"
    filepath <- file.path(filepath_prefix, filepath)
    rgx_rmv <- "Å|â€|œ|\u009d"
    rgx_detect_link <- "^\\+\\s+\\["
    rgx_detect_head <- "^\\s*\\#"
    rgx_link_post <- "(?<=\\[).*(?=\\])"
    rgx_link_img <- "(?<=\\!\\[).*(?=\\])"
    rgx_url <- "(?<=\\().*(?=\\))"
    rgx_head <- "(?<=\\#\\s).*$"
    
    lines <- readLines(filepath)
    # browser()
    lines_proc <-
      lines %>%
      # base64enc::base64decode() %>%
      # rawToChar() %>%
      stringr::str_split("\n") %>%
      purrr::flatten_chr() %>%
      as_tibble() %>%
      rename(text = value) %>%
      transmute(line = row_number(), text) %>%
      filter(text != "") %>%
      mutate(text = stringr::str_replace_all(text, rgx_rmv, "")) %>%
      mutate(
        is_link = ifelse(stringr::str_detect(text, rgx_detect_link), TRUE, FALSE),
        is_head = ifelse(stringr::str_detect(text, rgx_detect_head), TRUE, FALSE)
      ) %>%
      mutate(
        link_post = stringr::str_extract(text, rgx_link_post),
        link_img = stringr::str_extract(text, rgx_link_img),
        url = stringr::str_extract(text, rgx_url),
        head = stringr::str_extract(text, rgx_head)
      ) %>%
      mutate(
        is_head = ifelse(line == 1, TRUE, is_head),
        head = ifelse(line == 1, "YAML/Introduction", head)
      )

    # NOTE: Couldn't seem to get `zoo::na.locf()` to work properly.
    lines_head <-
      lines_proc %>%
      mutate(line_head = ifelse(is_head, line, 0)) %>%
      mutate(line_head = cumsum(line_head))
    
    out <-
      lines_head %>%
      select(-head) %>%
      inner_join(
        lines_head %>%
          filter(is_head == TRUE) %>%
          select(head, line_head),
        by = c("line_head")
      ) %>% 
      select(-line_head)
    out
  }

content <-
  posts_info %>% 
  # slice(1) %>% 
  transmute(num_post = row_number(), name, path) %>% 
  tidyr::nest(path, .key = "path") %>% 
  mutate(content = purrr::map(path, get_rweekly_post_content)) %>% 
  # tidyr::unnest(path) %>% 
  select(-path) %>% 
  tidyr::unnest(content)
content
```

```{r eval = FALSE, include = FALSE}
# filepath_data <- file.path("data", "content-rweekly.rds")
# saveRDS(content, file = filepath_data)
# content <- readRDS(filepath_data)
filepath_data <- file.path("data", "content-rweekly.csv")
# readr::write_csv(content, filepath_data)
content <- readr::read_csv(filepath_data)
```

```{r}
rgx_ignore <- "http|https|href|class|br|rweekly"

unigrams <-
  content %>%
  tetext::tidify_to_unigrams_at(
    text = "text",
    rgx_ignore = rgx_ignore
  )

bigrams <-
  content %>%
  tetext::tidify_to_bigrams_at(
    text = "text",
    rgx_ignore = rgx_ignore
  )
bigrams
viz_unigrams_cnts <-
  unigrams %>% 
  tetext::visualize_cnts_at(
    word = "word",
    num_top = 30
  )
viz_unigrams_cnts
```


