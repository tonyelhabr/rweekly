---
author: ""
date: ""
output:
  html_document::
    toc: false
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(
  echo = TRUE,
  cache = FALSE,
  results = "markdown",
  fig.align = "center",
  fig.show = "asis",
  fig.width = 6,
  fig.height = 6,
  # out.width = 6,
  # out.height = 6,
  warning = FALSE,
  message = FALSE
)
```

```{r}
library("dplyr")
library("stringr")
library("gh")
library("purrr")
```


```{r}
# Rerference:
# + https://itsalocke.com/blog/markdown-based-web-analytics-rectangle-your-blog/
posts <- gh::gh(
  "/repos/:owner/:repo/contents/:path",
  owner = "rweekly",
  repo = "rweekly.org",
  path = "_posts"
)

posts_info <-
  dplyr::data_frame(
    name = purrr::map_chr(posts, "name"),
    path = purrr::map_chr(posts, "path"),
    raw = purrr::map_chr(posts, "download_url")
  )
```

```{r eval = FALSE, include = FALSE}
# filepath_data <- file.path("data", "posts-rweekly.rds")
# saveRDS(posts_info, file = filepath_data)
data <- readRDS(filepath_data)
# filepath_data <- file.path("data", "posts-rweekly.csv")
# readr::write_csv(posts_info, filepath_data)
# data <- readr::read_csv(filepath_data)
```

```{r}
get_rweekly_post_lines <-
  function(path) {
    # Debugging...
    # path <- posts_info[[1]]$path
    
    filepath <- gh::gh(
      "/repos/:owner/:repo/contents/:path",
      owner = "rweekly",
      repo = "rweekly.org",
      path = path
    )
    rgx_rmv <- "Å|â€|œ|\u009d"
    rgx_detect_link <- "^\\+\\s+\\["
    rgx_detect_head <- "^\\s*\\#"
    rgx_link_post <- "(?<=\\[).*(?=\\])"
    rgx_link_img <- "(?<=\\!\\[).*(?=\\])"
    rgx_url <- "(?<=\\().*(?=\\))"
    rgx_head <- "(?<=\\#\\s).*$"
    
    lines <-
      filepath$content %>%
      base64enc::base64decode() %>%
      rawToChar() %>%
      stringr::str_split("\n") %>%
      purrr::flatten_chr() %>%
      as_tibble() %>%
      rename(text = value) %>%
      transmute(line = row_number(), text) %>%
      filter(text != "") %>%
      mutate(text = stringr::str_replace_all(text, rgx_rmv, "")) %>%
      mutate(
        is_link = ifelse(stringr::str_detect(text, rgx_detect_link), TRUE, FALSE),
        is_head = ifelse(stringr::str_detect(text, rgx_detect_head), TRUE, FALSE)
      ) %>%
      mutate(
        link_post = stringr::str_extract(text, rgx_link_post),
        link_img = stringr::str_extract(text, rgx_link_img),
        url = stringr::str_extract(text, rgx_url),
        head = stringr::str_extract(text, rgx_head)
      ) %>%
      mutate(
        is_head = ifelse(line == 1, TRUE, is_head),
        head = ifelse(line == 1, "YAML/Introduction", head)
      )

    # NOTE: Couldn't seem to get `zoo::na.locf()` to work properly.
    lines_head <-
      lines %>%
      mutate(line_head = ifelse(is_head, line, 0)) %>%
      mutate(line_head = cumsum(line_head))
    
    lines_proc <-
      lines_head %>%
      select(-head) %>%
      inner_join(
        lines_head %>%
          filter(is_head == TRUE) %>%
          select(head, line_head),
        by = c("line_head")
      )
    out <-
      lines_proc %>%
      mutate(path = path)
    out
  }

posts_lines <-
  purrr::map_df(posts_info$path, get_rweekly_post_lines)
```

